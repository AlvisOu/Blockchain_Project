<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Blockchain Demo Wallet</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        background: #fff;
        color: #000;
      }

      .wrapper {
        max-width: 600px;
        margin: 60px auto;
        background: #fff;
        padding: 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      h2,
      h3 {
        margin-top: 10px;
        color: #000;
      }

      input {
        padding: 6px;
        margin-right: 6px;
        font-size: 1rem;
      }

      button {
        padding: 6px 14px;
        margin: 6px 0;
        border: none;
        border-radius: 4px;
        background: #ccc;
        color: #000;
        font-size: 1rem;
        cursor: pointer;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      #out {
        background: #f7f7f7;
        border: 1px solid #ccc;
        padding: 12px;
        white-space: pre-wrap;
        min-height: 80px;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <h2>McDonalds Collectables Exchange</h2>

      <label>
        Username:
        <input id="user" placeholder="your name" />
        <button id="setUserBtn">Set</button>
        <span id="userSetMsg" style="color: green; margin-left: 10px"></span>
      </label>

      <div style="margin-top: 16px">
        <button id="listBtn">List Users</button>
        <button id="balBtn">Balance</button>
      </div>

      <h3>Send Collectables!</h3>
      <label for="recipient">Recipient:</label>
      <select id="recipientSelect">
        <option value="">-- Select a user --</option>
      </select>
      <input id="to" placeholder="recipient public key" />
      <input id="amt" type="number" min="1" placeholder="amount" />
      <button id="sendBtn">Send</button>

      <h3>Output</h3>
      <div id="out"></div>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      let userSet = false;

      /* Set username (cannot be changed once set) */
      $("setUserBtn").onclick = () => {
        const username = $("user").value.trim();
        if (!username) return alert("Enter a username first");
        if (userSet) return;

        fetch(`/api/init/${encodeURIComponent(username)}`).then((res) =>
          res.json().then((data) => {
            if (data.error) return alert(data.error);

            userSet = true;
            $("user").disabled = true;
            $("setUserBtn").disabled = true;
            $("userSetMsg").textContent = `Username set: ${username}`;
            render(`Username set! Welcome ${username}`);
          })
        );
      };

      const render = (text) => {
        $("out").textContent = text;
      };

      $("listBtn").onclick = () => {
        fetch("/api/list")
          .then((response) => response.json())
          .then((data) => {
            if (data.error) return render(data.error);

            // Display in output box
            const output = ["Users:"].concat(
              data.map((u) => `- ${u.name} (${u.public_key})`)
            ).join("\n");
            render(output);

            // Populate dropdown
            const select = $("recipientSelect");
            select.innerHTML = '<option value="">-- Select a user --</option>'; // clear
            data.forEach((user) => {
              const option = document.createElement("option");
              option.value = user.public_key;
              option.textContent = user.name;
              select.appendChild(option);
            });
            select.onchange = () => {
              $("to").value = select.value;
            };
          });
      };

      /* ---- Balance ---- */
      $("balBtn").onclick = () => {
        fetch(`/api/balance`)
          .then((response) => response.json())
          .then((data) => {
            if (data.error) return render(data.error);
            render(`Your balance is ${data.balance}`);
          });
      };

      /* Sending collectables */
      $("sendBtn").onclick = () => {
        if (!userSet) return alert("Set your username first");
        const sender = $("user").value.trim();
        const recipient = $("to").value.trim();
        const amount = parseInt($("amt").value, 10);
        if (!recipient || !amount) return alert("Fill recipient and amount");

        fetch("/api/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sender, recipient, amount }),
        }).then(async (response) => {
          const data = await response.json();
          if (data.success) {
            render(
              `Transaction Succeeded! You sent ${amount} coins to ${recipient}`
            );
          } else {
            const msg = data.message || "Transaction Failed. Unknown error.";
            if (msg.toLowerCase().includes("not enough")) {
              render(
                `Transaction Failed. You don't have enough money.\n${msg}`
              );
            } else if (msg.toLowerCase().includes("payee")) {
              render("Transaction Failed. The payee does not exist.");
            } else {
              render(`Transaction Failed. ${msg}`);
            }
          }
        });
      };
    </script>
  </body>
</html>
